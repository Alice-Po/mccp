---
import Layout from '../layouts/Layout.astro';
import DonutChart from '../components/DonutChart.svelte';
import DrillDownModal from '../components/DrillDownModal.svelte';
import FinanceNavigation from '../components/FinanceNavigation.svelte';
import HorizontalBarChart from '../components/HorizontalBarChart.svelte';
import FiscaliteTable from '../components/FiscaliteTable.svelte';
import IndicateursFinanciers from '../components/IndicateursFinanciers.svelte';
import { aggregateData, type BudgetItem, aggregateByChapitre } from '../utils/budget-data';

// Charger les donn√©es budg√©taires
let budgetData: BudgetItem[] = [];
try {
  // Import direct depuis le public folder
  budgetData = await import('../../public/assets/datas/2025/base_budget_2025.json').then(module => module.default as BudgetItem[]);
} catch (importError) {
  // Fallback avec fetch
  try {
    const response = await fetch('/assets/datas/2025/base_budget_2025.json');
    budgetData = await response.json();
  } catch (fetchError) {
    console.error('‚ùå Finances - Erreur chargement donn√©es:', fetchError);
    budgetData = [];
  }
}

// Pr√©parer les donn√©es pour toutes les sections

const fonctionnementDepenses = aggregateData(budgetData, 'FONCTIONNEMENT', 'DEPENSES', 'regroupement_focale_n1');
const fonctionnementRecettes = aggregateData(budgetData, 'FONCTIONNEMENT', 'RECETTES', 'regroupement_focale_n1');
const investissementDepenses = aggregateData(budgetData, 'INVESTISSEMENT', 'DEPENSES', 'regroupement_focale_n1');
const investissementRecettes = aggregateData(budgetData, 'INVESTISSEMENT', 'RECETTES', 'regroupement_focale_n1');

// Pr√©parer les donn√©es pour le bar chart fonctionnement/d√©penses et recettes par chapitre
const fonctionnementDepensesChapitre = aggregateByChapitre(budgetData, 'FONCTIONNEMENT', 'DEPENSES');
const fonctionnementRecettesChapitre = aggregateByChapitre(budgetData, 'FONCTIONNEMENT', 'RECETTES');
const investissementDepensesChapitre = aggregateByChapitre(budgetData, 'INVESTISSEMENT', 'DEPENSES');
const investissementRecettesChapitre = aggregateByChapitre(budgetData, 'INVESTISSEMENT', 'RECETTES');

// Charger les donn√©es de fiscalit√©
interface FiscaliteItem {
  type_taxe: string;
  taux_vote_commune_putanges: string;
  taux_moyen_communes_francaises_comparables: string;
  commentaire: string;
}

let fiscaliteData: FiscaliteItem[] = [];
try {
  fiscaliteData = await import('../../public/assets/datas/2025/fiscalite_2025.json').then(module => module.default as FiscaliteItem[]);
} catch (fiscaliteError) {
  console.error('‚ùå Finances - Erreur chargement donn√©es fiscalit√©:', fiscaliteError);
  fiscaliteData = [];
}

// Charger les donn√©es des indicateurs financiers
interface IndicateurFinancier {
  critere: string;
  definition_critere: string;
  valeur_putanges_le_lac_par_habitant: string;
  mediane_echantillon_par_habitant: string;
  classement_putanges_le_lac_sur_129: string;
  premier_decile_par_habitant: string;
  dernier_decile_par_habitant: string;
  commentaires: string;
}

let indicateursData: IndicateurFinancier[] = [];
try {
  indicateursData = await import('../../public/assets/datas/2025/indicateurs_financiers_2025.json').then(module => module.default as IndicateurFinancier[]);
} catch (indicateursError) {
  console.error('‚ùå Finances - Erreur chargement donn√©es indicateurs:', indicateursError);
  indicateursData = [];
}
---

<Layout title="Finances - MCCP">
  <main class="finances-main">
    <!-- Message d'avertissement pour les petits √©crans -->
    <div class="screen-warning">
      <div class="warning-content">
        <h2>üìä Consultation des Finances</h2>
        <p>Pour une meilleure exp√©rience de consultation des donn√©es financi√®res, nous vous recommandons d'utiliser un ordinateur ou un √©cran plus large.</p>
        <div class="warning-details">
          <p><strong>R√©solution minimale recommand√©e :</strong> 1400px de largeur</p>
          <p>Cette page contient des graphiques d√©taill√©s et des tableaux interactifs qui n√©cessitent plus d'espace d'affichage pour une lecture optimale.</p>
        </div>
        <div class="warning-actions">
          <a href="/" class="btn-home">‚Üê Retour √† l'accueil</a>
        </div>
      </div>
    </div>

    <!-- Contenu principal (masqu√© sur petits √©crans) -->
    <div class="finances-section">
      <div class="finances-layout">
      <!-- Navigation fixe √† gauche -->
      <aside class="finances-sidebar">
        <FinanceNavigation client:load />
      </aside>

      <!-- Contenu principal √† droite -->
      <div class="finances-content">
        <!-- En-t√™te -->
        <header class="finances-header">
          <h1>Finances municipales 2024</h1>
          <div class="download-section">
            <a href="/assets/datas/Budget-primitif-2025-Putanges.pdf" class="download-pdf-btn" download>
              <span class="download-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="7 10 12 15 17 10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
              </span>
              T√©l√©charger le budget au format PDF
            </a>
          </div>
        </header>

                <!-- Section Fonctionnement -->
        <section class="chart-section" id="section-budget-fonctionnement">
          <div class="section-header">
            <h2>Section de fonctionnement 2024</h2>
          </div>
          
          <!-- Onglets Donut Fonctionnement -->
          <div class="tabs-container" id="donut-tabs-fonctionnement">
            <div class="tabs">
              <button class="tab tab-active" data-tab="depenses" data-section="fonctionnement-donut">
                D√©penses
              </button>
              <button class="tab" data-tab="recettes" data-section="fonctionnement-donut">
                Recettes
              </button>
            </div>
          </div>

          <!-- Graphique Fonctionnement (Donut) -->
          <div class="chart-wrapper" id="chart-fonctionnement">
            <DonutChart 
              data={fonctionnementDepenses}
              title="D√©penses - Fonctionnement - R√©alisations 2024"
              chartId="chart-fonctionnement"
              enableDrillDown={true}
              client:load
            />
          </div>
        </section>
        
        <!-- Section Investissement -->
        <section class="chart-section" id="section-budget-investissement">
          <div class="section-header">
            <h2>Budget d'investissement 2024</h2>
          </div>
          
          <!-- Onglets Investissement -->
          <div class="tabs-container" id="donut-tabs-investissement">
            <div class="tabs">
              <button class="tab tab-active" data-tab="depenses" data-section="investissement">
                D√©penses
              </button>
              <button class="tab" data-tab="recettes" data-section="investissement">
                Recettes
              </button>
            </div>
          </div>

          <!-- Graphique Investissement -->
          <div class="chart-wrapper" id="chart-investissement">
            <DonutChart 
              data={investissementDepenses}
              title="D√©penses - Investissement - R√©alisations 2024"
              chartId="chart-investissement"
              enableDrillDown={true}
              client:load
            />
          </div>
        </section>
        <section class="chart-section" id="section-comparaison-fonctionnement">
          <div class="section-header">
            <h2>Comparaison fonctionnement 2024</h2>
          </div>

          <!-- Onglets BarChart Fonctionnement -->
          <div class="tabs-container" id="bar-tabs-fonctionnement">
            <div class="tabs">
              <button class="tab tab-active" data-tab="depenses" data-section="fonctionnement-bar">
                D√©penses
              </button>
              <button class="tab" data-tab="recettes" data-section="fonctionnement-bar">
                Recettes
              </button>
            </div>
          </div>

          <!-- Bar chart de comparaison par chapitre, interactif avec ses propres onglets -->
          <div class="chart-wrapper" id="bar-fonctionnement">
            <HorizontalBarChart 
              data={fonctionnementDepensesChapitre}
              type="expenses"
              title="Comparaison des d√©penses par chapitre (Pr√©vus, R√©alis√©s, Propositions)"
              client:load
            />
          </div>
        </section>

        <section class="chart-section" id="section-comparaison-investissement">
          <div class="section-header">
            <h2>Comparaison investissement 2024</h2>
          </div>

          <!-- Onglets BarChart Fonctionnement -->
          <div class="tabs-container" id="bar-tabs-investissement">
            <div class="tabs">
              <button class="tab tab-active" data-tab="depenses" data-section="investissement-bar">
                D√©penses
              </button>
              <button class="tab" data-tab="recettes" data-section="investissement-bar">
                Recettes
              </button>
            </div>
          </div>

          <!-- Bar chart de comparaison par chapitre, interactif avec ses propres onglets -->
          <div class="chart-wrapper" id="bar-investissement">
            <HorizontalBarChart 
              data={investissementDepensesChapitre}
              type="expenses"
              title="Comparaison des d√©penses par chapitre (Pr√©vus, R√©alis√©s, Propositions)"
              chartId="bar-investissement"
              client:load
            />
          </div>
        </section>

        <!-- Section Fiscalit√© -->
        <section class="chart-section" id="section-fiscalite">
          <div class="section-header">
            <h2>Fiscalit√© locale 2025</h2>
          </div>
          
          <!-- Tableau de fiscalit√© -->
          <div class="chart-wrapper" id="fiscalite-wrapper">
            <FiscaliteTable 
              data={fiscaliteData}
              client:load
            />
          </div>
        </section>

        <!-- Section Indicateurs Financiers -->
        <section class="chart-section" id="section-indicateurs-financiers">
          <div class="section-header">
            <h2>Indicateurs financiers 2025</h2>
            <p>Analyse des principaux indicateurs de sant√© financi√®re</p>
          </div>
          
          <!-- Indicateurs financiers -->
          <div class="chart-wrapper" id="indicateurs-wrapper">
            <IndicateursFinanciers 
              data={indicateursData}
              client:load
            />
          </div>
        </section>
        <!-- Section Conclusion -->
  <div id="section-conclusion" class="conclusion-section">
    <div class="conclusion-header">
      <h2>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 21L16.514 16.506L21 21ZM19 10.5C19 15.194 15.194 19 10.5 19C5.806 19 2 15.194 2 10.5C2 5.806 5.806 2 10.5 2C15.194 2 19 5.806 19 10.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        Conclusion
      </h2>
    </div>
    <div class="conclusion-content">
      <p>
        La commune de Putanges-le-Lac pr√©sente une situation financi√®re tr√®s saine. Elle est tr√®s peu endett√©e et d√©gage, chaque ann√©e, des marges de man≈ìuvre budg√©taires qui peuvent √™tre mobilis√©es pour financer des projets d'√©quipement. Revers de cette situation financi√®re, on peut relever le faible niveau d'intervention de la commune. C'est notamment le cas en mati√®re de soutien au tissu associatif. C'est √©galement le cas des projets d'√©quipement dont les r√©alisations sont tr√®s en-de√ßa des inscriptions pr√©vues dans le cadre du budget.
      </p>
      <p>
        Le niveau de la pression fiscale peut √©galement interroger : le taux de la taxe fonci√®re est le 28√®me le plus √©lev√© sur l'√©chantillon des 113 communes de l'Orne de la m√™me strate d√©mographique (source OFGL). Putanges-le-Lac appara√Æt donc comme une commune qui mobilise beaucoup de moyens, tant aupr√®s de l'√âtat que des contribuables, pour une mise en oeuvre de services et de projets sur le territoire tr√®s prudente, voire insuffisante.
      </p>
      <p>
        Il faut √©galement noter la situation relative par rapport √† la communaut√© de communes : alors que la communaut√© porte l'essentiel des services √† la population, elle se trouve dans une situation financi√®re tendue, aux antipodes de la commune principale. Ceci peut questionner la pertinence de l'√©quilibre fiscal trouv√© entre communes et communaut√©.
      </p>
    </div>
  </div>

  <!-- Section Source -->
  <div class="source-section">
    <div class="source-content">
      <span class="source-label">Sources :</span>
      <span class="source-text">OFGL - Observatoire des finances et de la gestion publique locales ‚Ä¢ Direction g√©n√©rale des finances publiques</span>
    </div>
  </div>
</div>


      </div>
    </div>

    <!-- Modal de drill-down -->
    <DrillDownModal 
      budgetData={budgetData}
      client:only="svelte"
    />

    <!-- Script pour g√©rer la navigation et les onglets -->
      <script define:vars={{ fonctionnementDepenses, fonctionnementRecettes, investissementDepenses, investissementRecettes, fonctionnementDepensesChapitre, fonctionnementRecettesChapitre, investissementDepensesChapitre, investissementRecettesChapitre }}>
        document.addEventListener('DOMContentLoaded', () => {
          
          // ===== CONFIGURATION DES DONN√âES =====
          const chartConfigs = {
            'donut-tabs-fonctionnement': {
              chartId: 'chart-fonctionnement',
              section: 'Fonctionnement',
              dataMap: {
                depenses: fonctionnementDepenses,
                recettes: fonctionnementRecettes
              }
            },
            'donut-tabs-investissement': {
              chartId: 'chart-investissement', 
              section: 'Investissement',
              dataMap: {
                depenses: investissementDepenses,
                recettes: investissementRecettes
              }
            },
            'bar-tabs-fonctionnement': {
              chartId: 'bar-fonctionnement',
              section: 'Fonctionnement',
              dataMap: {
                depenses: { data: fonctionnementDepensesChapitre, type: 'expenses' },
                recettes: { data: fonctionnementRecettesChapitre, type: 'revenues' }
              }
            },
            'bar-tabs-investissement': {
              chartId: 'bar-investissement',
              section: 'Investissement', 
              dataMap: {
                depenses: { data: investissementDepensesChapitre, type: 'expenses' },
                recettes: { data: investissementRecettesChapitre, type: 'revenues' }
              }
            }
          };

          // ===== FONCTIONS UTILITAIRES =====
          function dispatchChartUpdate(config) {
            const updateEvent = new CustomEvent('updateChart', { detail: config });
            document.dispatchEvent(updateEvent);
          }

          function generateTitle(tabType, section, isBarChart = false) {
            const typeLabel = tabType === 'depenses' ? 'D√©penses' : 'Recettes';
            const prefix = isBarChart ? 'Comparaison des' : '';
            const suffix = isBarChart ? 'par chapitre (Pr√©vus, R√©alis√©s, Propositions)' : '- R√©alisations 2024';
            return `${prefix} ${typeLabel} - ${section} ${suffix}`.trim();
          }

          // ===== GESTIONNAIRE D'ONGLETS G√âN√âRIQUE =====
          function createTabManager(selectorId, config) {
            const tabs = document.querySelectorAll(`#${selectorId} .tab`);
            const isBarChart = selectorId.includes('bar-tabs');
            
            function updateChart(tabType) {
              const dataConfig = config.dataMap[tabType];
              const title = generateTitle(tabType, config.section, isBarChart);
              
              if (isBarChart) {
                // Configuration pour les bar charts
                dispatchChartUpdate({
                  data: dataConfig.data,
                  title: title,
                  chartId: config.chartId,
                  type: dataConfig.type
                });
              } else {
                // Configuration pour les donut charts
                dispatchChartUpdate({
                  data: dataConfig,
                  title: title,
                  chartId: config.chartId
                });
              }
            }
            
            // Setup des event listeners
            tabs.forEach(tab => {
              tab.addEventListener('click', () => {
                // Mise √† jour des styles
                tabs.forEach(t => t.classList.remove('tab-active'));
                tab.classList.add('tab-active');
                
                // Mise √† jour du graphique
                updateChart(tab.dataset.tab);
              });
            });
            
            // Initialisation par d√©faut
            updateChart('depenses');
          }

          // ===== INITIALISATION DES GESTIONNAIRES D'ONGLETS =====
          Object.entries(chartConfigs).forEach(([selectorId, config]) => {
            createTabManager(selectorId, config);
          });

          // ===== GESTION DU DRILL-DOWN =====
          let currentModalState = {
            isOpen: false,
            selectedCategory: '',
            section: '',
            type: '',
            valueField: 'REALISATIONS_2024'
          };

          // √âcouter les √©v√©nements de clic sur les segments du donut
          document.addEventListener('segmentClick', (event) => {
            const { category } = event.detail;
            
            // D√©terminer la section √† partir du donut cliqu√©
            let section = '';
            let type = '';
            
            // V√©rifier dans quelle section se trouve la cat√©gorie
            const isFonctionnementCategory = fonctionnementDepenses.some(item => item.label === category) || 
                                           fonctionnementRecettes.some(item => item.label === category);
            const isInvestissementCategory = investissementDepenses.some(item => item.label === category) || 
                                           investissementRecettes.some(item => item.label === category);
            
            if (isFonctionnementCategory) {
              section = 'FONCTIONNEMENT';
              const activeFonctionnementTab = document.querySelector('#donut-tabs-fonctionnement .tab-active');
              type = activeFonctionnementTab?.dataset.tab === 'recettes' ? 'RECETTES' : 'DEPENSES';
            } else if (isInvestissementCategory) {
              section = 'INVESTISSEMENT';
              const activeInvestissementTab = document.querySelector('#donut-tabs-investissement .tab-active');
              type = activeInvestissementTab?.dataset.tab === 'recettes' ? 'RECETTES' : 'DEPENSES';
            } else {
              // Par d√©faut
              section = 'FONCTIONNEMENT';
              type = 'DEPENSES';
            }

            // Mettre √† jour l'√©tat de la modal
            currentModalState = {
              isOpen: true,
              selectedCategory: category,
              section,
              type,
              valueField: 'REALISATIONS_2024'
            };

            // Dispatcher l'√©v√©nement pour ouvrir la modal
            const openModalEvent = new CustomEvent('openDrillDownModal', {
              detail: currentModalState
            });
            document.dispatchEvent(openModalEvent);
          });

          // √âcouter la fermeture de la modal
          document.addEventListener('closeDrillDownModal', () => {
            currentModalState.isOpen = false;
          });

        });
      </script>
    </div>
    </div>
  </main>
</Layout>

<style>
  .finances-main {
    min-height: 100vh;
    background-color: #f9fafb;
    max-width: 1600px;
  }

  /* Message d'avertissement - masqu√© par d√©faut */
  .screen-warning {
    display: none;
    min-height: 100vh;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  }

  .warning-content {
    max-width: 600px;
    text-align: center;
    background: white;
    padding: 3rem;
    border-radius: 1.5rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    border: 2px solid #2e8b57;
  }

  .warning-content h2 {
    color: #2e8b57;
    margin-bottom: 1.5rem;
    font-size: 2rem;
  }

  .warning-content p {
    color: #495057;
    margin-bottom: 1rem;
    line-height: 1.6;
    font-size: 1.1rem;
  }

  .warning-details {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 1rem;
    margin: 2rem 0;
    border-left: 4px solid #2e8b57;
  }

  .warning-details p {
    margin-bottom: 0.5rem;
    font-size: 1rem;
  }

  .btn-home {
    display: inline-block;
    padding: 1rem 2rem;
    background: #2e8b57;
    color: white;
    text-decoration: none;
    border-radius: 0.5rem;
    font-weight: 600;
    transition: all 0.2s ease;
    margin-top: 1rem;
  }

  .btn-home:hover {
    background: #1b5e39;
    transform: translateY(-2px);
  }

  .finances-content section{
    margin: 0 auto;
  }

  .finances-layout {
    display: flex;
    gap: 2rem;
    min-height: 100vh;
    max-width: 1600px;
    margin: 0 auto;
    padding: 2rem;
  }

  .finances-sidebar {
    flex-shrink: 0;
  }

  .finances-content {
    flex: 1;
    min-width: 0;
  }

  .finances-header {
    text-align: left;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(46, 139, 87, 0.1);
  }

  .finances-header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--secondary);
    margin-bottom: 1rem;
  }

  .finances-header p {
    font-size: 1.1rem;
    color: #6b7280;
    max-width: 600px;
    margin: 0 auto;
  }

  .chart-section {
    border-radius: 1rem;
    padding: 2rem;
    margin-bottom: 2rem;
    scroll-margin-top: 2rem;
  }

  .section-header {
    text-align: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(46, 139, 87, 0.1);
  }

  .section-header h2 {
    font-size: 1.8rem;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 0.5rem;
  }

  .section-header p {
    font-size: 1rem;
    color: #6b7280;
    margin: 0;
  }

  .tabs-container {
    margin-bottom: 2rem;
  }

  .tabs {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .tab {
    background: none;
    border: none;
    padding: 0.5rem 1.5rem;
    font-size: 1rem;
    font-weight: 600;
    color: #333;
    border-bottom: 2.5px solid transparent;
    cursor: pointer;
    transition: color 0.2s, border-color 0.2s, background-color 0.2s;
    border-radius: 0.25rem 0.25rem 0 0;
  }

  .tab:hover {
    color: #1976d2;
  }

  .tab:focus {
    outline: 2px solid #1976d2;
  }

  .tab-active {
    color: #1976d2 !important;
    border-bottom-color: #1976d2 !important;
    background-color: #f5faff;
  }

  .chart-wrapper {
    min-height: 400px;
  }

  /* Affichage conditionnel bas√© sur la largeur d'√©cran */
  @media (max-width: 1399px) {
    .screen-warning {
      display: flex;
    }
    
    .finances-section {
      display: none;
    }
  }

  /* Styles pour √©crans ‚â• 1400px */
  @media (min-width: 1400px) {
    .screen-warning {
      display: none;
    }
    
    .finances-section {
      display: block;
    }
  }

  /* Responsive pour les grands √©crans */
  @media (min-width: 1400px) and (max-width: 1599px) {
    .finances-layout {
      gap: 1.5rem;
      padding: 1.5rem;
    }
  }

  /* Styles normaux pour grands √©crans - pas de modifications de layout */


  .download-section {
      display: flex;
      justify-content: center;
      margin: -0.5rem 0 2.5rem;
    }

    .download-pdf-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--primary);
      padding: 0.5rem 1rem;
      border-radius: 2rem;
      text-decoration: none;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.2s ease;
      border: 1px solid var(--primary);
      background: transparent;
    }

    .download-pdf-btn:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-1px);
    }

    .download-icon {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .download-pdf-btn svg {
      width: 20px;
      height: 20px;
      transition: transform 0.2s ease;
    }

    .download-pdf-btn:hover svg {
      transform: translateY(2px);
    }
</style>