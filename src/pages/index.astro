---
import Layout from "../layouts/Layout.astro";
import Image from "../components/Image.astro";
import Download from "../components/commonsElements/Download.svelte";
import { getCollection } from 'astro:content';
import { formatTimeRange } from '../utils/time-formatting';
import fs from 'fs';
import path from 'path';
import "../styles/global.css";

// Récupérer les articles de blog
const allPosts = await getCollection('blog', ({ data }) => !data.draft);

// Trier par date et prendre les 3 plus récents
const recentPosts = allPosts
  .sort((a, b) => new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf())
  .slice(0, 3);

// Récupérer les événements de l'agenda
const allEvents = await getCollection('agenda' as any, ({ data }: any) => !data.draft);

// Trier par date et prendre les 3 prochains événements
const upcomingEvents = allEvents
  .sort((a: any, b: any) => new Date(a.data.date).valueOf() - new Date(b.data.date).valueOf())
  .slice(0, 3);

// Fonction pour générer un slug à partir du titre
function generateSlug(title: string) {
  return title
    .toLowerCase()
    .replace(/[^\w\s]/g, '')
    .replace(/\s+/g, '-');
}

// Fonction pour lire et encoder le contenu d'un fichier .ics
function getIcsDataUrl(vcalendarPath: string): string | null {
  try {
    // Construire le chemin vers le fichier dans public/
    const publicPath = path.join(process.cwd(), 'public', vcalendarPath.replace('/assets/', 'assets/'));
    
    if (fs.existsSync(publicPath)) {
      const content = fs.readFileSync(publicPath, 'utf8');
      const base64 = Buffer.from(content).toString('base64');
      return `data:application/ics;charset=utf-8;base64,${base64}`;
    }
  } catch (error) {
    console.warn(`Erreur lors de la lecture du fichier .ics: ${vcalendarPath}`, error);
  }
  return null;
}

// Fonction pour construire un lien Google Calendar
function toGCalDate(date: Date, time?: string) {
  const d = new Date(date);
  let hours = 0;
  let minutes = 0;
  if (time && time.includes('-')) {
    const [h, m] = time.split('-');
    hours = parseInt(h, 10) || 0;
    minutes = parseInt(m, 10) || 0;
  }
  d.setHours(hours, minutes, 0, 0);
  // Google Calendar attend UTC sans séparateurs
  const iso = new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString();
  return iso.replace(/[-:]/g, '').split('.')[0] + 'Z';
}

function buildGoogleCalendarUrl(event: any) {
  const start = toGCalDate(event.data.date, event.data.start);
  const end = event.data.end ? toGCalDate(event.data.date, event.data.end) : undefined;
  const dates = end ? `${start}/${end}` : start;
  const base = 'https://calendar.google.com/calendar/render?action=TEMPLATE';
  const params = new URLSearchParams({
    text: event.data.title,
    dates,
    details: event.data.description || '',
    location: event.data.place || '',
  });
  return `${base}&${params.toString()}`;
}

// Fonction pour construire un lien Outlook (web)
function buildOutlookUrl(event: any) {
  const start = toGCalDate(event.data.date, event.data.start); // UTC Z format
  const end = event.data.end ? toGCalDate(event.data.date, event.data.end) : undefined;
  const base = 'https://outlook.live.com/calendar/0/deeplink/compose?path=/calendar/action/compose&rru=addevent';
  const params = new URLSearchParams({
    subject: event.data.title,
    startdt: start,
    enddt: end || start,
    body: event.data.description || '',
    location: event.data.place || '',
  });
  return `${base}&${params.toString()}`;
}
---

<Layout title="MCCP">
  <main>
    <section class="hero-section">
      <div class="hero-content">
        <h1>
          UNE LISTE CITOYENNE POUR LES ÉLECTIONS MUNICIPALES 2026
        </h1>
        <p>
          Porté par le Mouvement Citoyen des Communes de Putanges-le-Lac
        </p>
      </div>
      <div class="photo-credit">
        Photo du lac de Rabodanges © Auré
      </div>
    </section>

    <div class="content-wrapper">
      <!-- Section Ambitions -->
      <section class="ambitions-section">
        <h2>Nos ambitions</h2>
        <ul>
          <li>
            Des <strong>bourgs vivants</strong> où l'esprit de village est conservé
          </li>
          <li>
            Une véritable <strong>solidarité</strong> entre nos différentes communes et entre <strong>générations</strong>
          </li>
          <li>
            Des <strong>commerces locaux</strong> et <strong>services essentiels</strong> accessibles à tous les habitants
          </li>
          <li>
            Une <strong>économie locale</strong> dynamique créant des emplois durables
          </li>
          <li>
            Un environnement préservé et valorisé pour notre santé et les <strong>générations futures</strong>
          </li>
        </ul>
      </section>

      <!-- Section texte -->
      <section class="text-section">
        <p>
          Nous pensons qu'un programme politique doit être défini en concertation avec l'ensemble des habitants qui souhaitent exprimer leur avis, leurs envies et leurs besoins, en embrassant toute la diversité de la population de Putanges-le-Lac.
        </p>
        <p>
          Le programme, c'est donc tous ensemble que nous le travaillerons, par divers moyens : des débats publics, du porte à porte, ou autour d'un verre.
        </p>
      </section>

      <!-- Section Valeurs -->
      <section class="values-section">
        <h2>Nos valeurs</h2>
        <ul>
          <li>
            <strong>Démocratie participative</strong>, les décisions importantes sont prises avec les habitants
          </li>
          <li>
            <strong>Équité</strong>, entre toutes les communes
          </li>
          <li>
            <strong>Solidarité</strong>, entre générations et entre tous les habitants
          </li>
          <li>
            <strong>Transparence et éthique</strong>, dans la gestion des affaires publiques
          </li>
          <li>
            <strong>Respect</strong>, des paysages et de l'environnement. Préservation des ressources naturelles de notre territoire
          </li>
          <li>
            <strong>Inclusion</strong>, de toutes et tous, quelles que soient les différences
          </li>
        </ul>
      </section>

      <!-- Section Événements à venir -->
      <section class="events-section">
        <h2>Événements à venir</h2>
        
        <div class="events-grid">
          {upcomingEvents.map((event: any) => {
            return (
              <article class="event-card">
                <div class="event-date-header">
                  <svg class="date-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8 2V5M16 2V5M3.5 9.09H20.5M21 8.5V17C21 20 19.5 22 16 22H8C4.5 22 3 20 3 17V8.5C3 5.5 4.5 3.5 8 3.5H16C19.5 3.5 21 5.5 21 8.5Z" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M15.6947 13.7H15.7037M15.6947 16.7H15.7037M11.9955 13.7H12.0045M11.9955 16.7H12.0045M8.29431 13.7H8.30329M8.29431 16.7H8.30329" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <time datetime={event.data.date.toISOString()}>
                    {event.data.date.toLocaleDateString('fr-FR')}
                  </time>
                </div>
                <div class="event-content">
                  <h3>{event.data.title}</h3>
                  <div class="event-meta">
                    {event.data.start && (
                      <div class="meta-item">
                        <svg class="meta-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span class="event-time">
                          {formatTimeRange(event.data.start, event.data.end)}
                        </span>
                      </div>
                    )}
                    <div class="meta-item">
                      <svg class="meta-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z" fill="currentColor"/>
                      </svg>
                      <p class="event-place">{event.data.place}</p>
                    </div>
                  </div>
                  <p class="description">{event.data.description}</p>
                  
                  {event.data.vcalendar && (() => {
                    const icsDataUrl = getIcsDataUrl(event.data.vcalendar);
                    const gcalUrl = buildGoogleCalendarUrl(event);
                    const outlookUrl = buildOutlookUrl(event);
                    return (
                      <div class="event-downloads">
                        <h4>Ajouter à votre calendrier</h4>
                        <div class="download-buttons">
                          <a href={gcalUrl} target="_blank" rel="noopener noreferrer" class="provider-btn gmail">
                            <img src="/assets/img/logo/gagenda-icon.png" alt="Google Agenda" width="18" height="18" />
                            <span>Google Agenda</span>
                          </a>
                          <a href={outlookUrl} target="_blank" rel="noopener noreferrer" class="provider-btn outlook">
                            <img src="/assets/img/logo/outlook-icon.png" alt="Outlook" width="18" height="18" />
                            <span>Outlook</span>
                          </a>
                          {icsDataUrl && (
                            <a href={icsDataUrl} class="provider-btn download">
                              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              </svg>
                              <span>ICS</span>
                            </a>
                          )}
                        </div>
                      </div>
                    );
                  })()}
                  
                  {(event.data.flyers || event.data.image) && (
                    <div class="event-downloads">
                      <button class="download-toggle" onclick="toggleDownloads(this)">
                        <h4>Télécharger le flyer</h4>
                        <svg class="toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      </button>
                      <div class="download-content">
                        <div class="download-buttons">
                          {event.data.flyers && (
                            <a href={event.data.flyers} target="_blank" rel="noopener noreferrer" class="download-link">
                              <svg class="download-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              </svg>
                              <span>PDF</span>
                            </a>
                          )}
                          {event.data.image && (
                            <a href={event.data.image} target="_blank" rel="noopener noreferrer" class="download-link">
                              <svg class="download-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              </svg>
                              <span>Image</span>
                            </a>
                          )}
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </article>
            );
          })}
        </div>
      </section>

      <!-- Nouvelle section Actualités -->
      <section class="news-section">
        <h2>Dernières actualités</h2>
        
        <div class="news-grid">
          {recentPosts.map(post => {
            const slug = (post as any).slug || generateSlug(post.data.title);
            
            return (
              <article class="news-card">
                <a href={`/blog/${slug}`} class="card-link">
                  {post.data.image && (
                    <img src={post.data.image} alt={post.data.title} />
                  )}
                  <div class="news-content">
                    <h3>{post.data.title}</h3>
                    <div class="post-meta">
                      <time datetime={post.data.pubDate.toISOString()}>
                        {post.data.pubDate.toLocaleDateString('fr-FR')}
                      </time>
                    </div>
                    <p class="description">{post.data.description}</p>
                    <span class="read-more">
                      Lire la suite →
                    </span>
                  </div>
                </a>
              </article>
            );
          })}
        </div>
        
        <div class="view-all">
          <a href="/blog" class="view-all-link">Voir toutes les actualités</a>
        </div>
      </section>

      <!-- Section Contribution -->
      <section class="contribution-section">
        <h2>Envie de contribuer ?</h2>
        <div class="max-w-3xl mx-auto">
          <p class="text-secondary">Vous décidez de votre niveau d'engagement</p>
          
          <ul class="space-y-6">
            <li>
              <h3 class="text-lg font-bold text-secondary">Restez informé !</h3>
              <p>Laisser-nous vos coordonnées, téléphone ou email. C'est déjà nous soutenir et montrer votre intérêt.</p>
              <iframe id="infolettre" data-w-type="embedded" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://sq3k4.mjt.lu/wgt/sq3k4/xyg5/form?c=4d1df53c" width="100%" style="height: 0;"></iframe>

<script type="text/javascript" src="https://app.mailjet.com/pas-nc-embedded-v1.js"></script>



            </li>
            <li class="pb-4">
              <h3 class="text-lg font-bold text-secondary mt-4">Suivez-nous sur les réseaux sociaux</h3>
              <p>Restez informés de nos actualités et événements</p>
              <div class="social-buttons">
                <a href="https://www.facebook.com/mccputanges" target="_blank" rel="noopener noreferrer">
                  <img src="/assets/img/logo/Facebook-logo.png" alt="Facebook" />
                </a>
                <a href="https://www.instagram.com/mccputanges" target="_blank" rel="noopener noreferrer">
                  <img src="/assets/img/logo/Instagram-logo.png" alt="Instagram" />
                </a>
                <a href="https://signal.group/#CjQKIHatjGOpligTeLvBUasgAsfJIF9AcHi8nyJwiSYmDFUREhB3s7vbwUa3TKxpen31V0iK" target="_blank" rel="noopener noreferrer">
                  <img src="/assets/img/logo/Signal-logo.png" alt="Signal" />
                </a>
              </div>
            </li>
            <li>
              <h3 class="text-lg font-bold text-secondary mt-4">Parlez en autour de vous !</h3>
              <p>Nous cherchons toujours des énergies vives.</p>
            </li>
            
            <li>
              <h3 class="text-lg font-bold text-secondary">Partagez vos idées</h3>
              <ul class="ml-6 space-y-2 list-disc">
                <li>Par mail : Envoyez-nous vos suggestions par mail. Un conseil, une idée, une préoccupation ? Nous vous écoutons.</li>
                <li>Par téléphone : Accordez-nous un temps d'échange par téléphone ou en personne.</li>
              </ul>
            </li>
            
            <li>
              <h3 class="text-lg font-bold text-secondary">Rencontrons-nous !</h3>
              <p>Participez à nos rencontres, des moments conviviaux pour apprendre et échanger.</p>
            </li>
            
            <li>
              <h3 class="text-lg font-bold text-secondary">Rejoignez-nous !</h3>
              <p>Participez aux réunions de travail de préparation de la liste deux soirées par mois.</p>
            </li>
          </ul>
        </div>
  </section>

      <!-- Section Contact -->
      <section class="contact-section" id="contact">
        <h2>Contactez-nous</h2>
        <p>Vous pouvez nous contacter par téléphone ou par email.<p>
          <a href="tel:0767020716" class="phone-button">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M22 16.92V19.92C22.0011 20.1985 21.9441 20.4742 21.8325 20.7293C21.7209 20.9845 21.5573 21.2136 21.3521 21.4019C21.1468 21.5901 20.9046 21.7335 20.6407 21.8227C20.3769 21.9119 20.0974 21.9451 19.82 21.92C16.7428 21.5856 13.787 20.5341 11.19 18.85C8.77382 17.3147 6.72533 15.2662 5.18999 12.85C3.49997 10.2412 2.44824 7.27099 2.11999 4.18C2.095 3.90347 2.12787 3.62476 2.21649 3.36162C2.30512 3.09849 2.44756 2.85669 2.63476 2.65162C2.82196 2.44655 3.0498 2.28271 3.30379 2.17052C3.55777 2.05833 3.83233 2.00026 4.10999 2H7.10999C7.59531 1.99522 8.06579 2.16708 8.43376 2.48353C8.80173 2.79999 9.04207 3.23945 9.10999 3.72C9.23662 4.68007 9.47144 5.62273 9.80999 6.53C9.94454 6.88792 9.97366 7.27691 9.8939 7.65088C9.81415 8.02485 9.62886 8.36811 9.35999 8.64L8.08999 9.91C9.51355 12.4135 11.5865 14.4864 14.09 15.91L15.36 14.64C15.6319 14.3711 15.9751 14.1858 16.3491 14.1061C16.7231 14.0263 17.1121 14.0555 17.47 14.19C18.3773 14.5286 19.3199 14.7634 20.28 14.89C20.7658 14.9585 21.2094 15.2032 21.5265 15.5775C21.8437 15.9518 22.0122 16.4296 22 16.92Z" fill="white"/>
            </svg>
            07 67 02 07 16
          </a>
        
        <form 
          action="https://formspree.io/f/xjkyqpag"
          method="POST"
          class="contact-form"
        >
          <div class="form-group">
            <label for="email">Votre email</label>
            <input 
              type="email" 
              id="email"
              name="email" 
              required
              placeholder="exemple@email.com"
            />
          </div>

          <div class="form-group">
            <label for="message">Votre message</label>
            <textarea 
              id="message"
              name="message" 
              required
              placeholder="Partagez-nous vos idées, questions ou suggestions..."
              rows="5"
            ></textarea>
          </div>

          <button type="submit">
            Envoyer
          </button>
        </form>
      </section>

      <!-- Nouvelle section Kit de communication -->
      <section class="kit-section">
        <h2>Kit de communication</h2>
        <p>Téléchargez et partagez nos documents d'information pour faire connaître notre initiative.</p>
        
        <div class="documents-grid">
          <div class="document-card">
            <div class="document-icon">📄</div>
            <div class="document-info">
              <h3>Livret d'accueil</h3>
              <p>Livret d'accueil de la démarche et de nos valeurs</p>
              <Download 
                url="/assets/img/MCCP-Livret-daccueil.pdf"
                label="Livret d'accueil"
                format="PDF"
                inverted={true}
              />
            </div>
          </div>
          
          <div class="document-card">
            <div class="document-icon">📄</div>
            <div class="document-info">
              <h3>Tract à imprimer</h3>
              <p>Carte de visite à distribuer pour informer sur notre initiative citoyenne</p>
              <Download 
                url="/assets/img/tract-a-imprimer.pdf"
                label="Tract à imprimer"
                format="PDF"
                inverted={true}
              />
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

<script is:inline>
function toggleDownloads(button) {
  const content = button.nextElementSibling;
  const icon = button.querySelector('.toggle-icon');
  
  if (content.style.maxHeight) {
    // Fermer
    content.style.maxHeight = '';
    icon.style.transform = 'rotate(0deg)';
    button.classList.remove('active');
  } else {
    // Ouvrir
    content.style.maxHeight = content.scrollHeight + 'px';
    icon.style.transform = 'rotate(180deg)';
    button.classList.add('active');
  }
}
</script>

<style>
.contribution-section li {
  margin-top: 1rem;
}

.social-buttons a {
  display: inline-block;
  text-decoration: none;
  transition: transform 0.2s ease;
}

.social-buttons a:hover {
  transform: scale(1.1);
}

.social-buttons img {
  width: 100px;
  height: 80px;
  display: block;
  object-fit: contain;
}
</style>
 
 