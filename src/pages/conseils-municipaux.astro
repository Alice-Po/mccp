---
import Layout from '../layouts/Layout.astro';
import DocumentArborescence from '../components/DocumentArborescence.svelte';
import PdfViewer from '../components/PdfViewer.svelte';
---

<Layout title="Conseils Municipaux - MCCP">
  <main class="conseils-main">
    <!-- Container deux colonnes -->
    <div class="conseils-container" id="conseilsContainer">
      <!-- Colonne 1 : Arborescence des documents -->
      <div class="arborescence-column" id="arborescenceColumn">
        <DocumentArborescence client:load />
      </div>
      
      <!-- Colonne 2 : Viewer PDF -->
      <div class="viewer-column" id="viewerColumn">
        <PdfViewer client:load />
      </div>
    </div>
  </main>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    let isMobileViewerMode = false;

    // Fonction pour v√©rifier si on est en mode mobile
    function isMobile() {
      return window.innerWidth <= 768;
    }

    // Fonction pour basculer entre arborescence et viewer en mobile
    function toggleMobileView(showViewer = false) {
      const container = document.getElementById('conseilsContainer');
      const arborescenceColumn = document.getElementById('arborescenceColumn');
      const viewerColumn = document.getElementById('viewerColumn');

      if (!container || !arborescenceColumn || !viewerColumn) return;

      if (isMobile()) {
        if (showViewer) {
          // Mode viewer : cacher arborescence, montrer viewer
          container.classList.add('mobile-viewer-mode');
          arborescenceColumn.classList.add('mobile-hidden');
          viewerColumn.classList.add('mobile-visible');
          isMobileViewerMode = true;
        } else {
          // Mode arborescence : montrer arborescence, cacher viewer
          container.classList.remove('mobile-viewer-mode');
          arborescenceColumn.classList.remove('mobile-hidden');
          viewerColumn.classList.remove('mobile-visible');
          isMobileViewerMode = false;
        }
      }
    }

    // √âcouter le retour depuis le viewer mobile
    document.addEventListener('mobileBackToArborescence', () => {
      console.log('üì° Page - Retour √† l\'arborescence mobile');
      toggleMobileView(false);
    });

    // √âcouter la s√©lection de documents depuis DocumentArborescence
    document.addEventListener('documentSelected', (event: any) => {
      console.log('üì° Page - √âv√©nement documentSelected re√ßu:', event);
      const doc = event.detail?.doc;
      console.log('üì° Page - Document extrait:', doc);
      
      if (doc && doc.name) {
        console.log('üì° Page - Traitement document:', doc.name);
        
        // Construire l'URL du PDF
        const pdfUrl : string = doc.path;
        console.log('üì° Page - URL PDF:', pdfUrl);
        
        // En mobile, basculer vers le viewer
        if (isMobile()) {
          toggleMobileView(true);
        }
        
        // Mettre √† jour le composant PdfViewer via √©v√©nement personnalis√©
        const updateEvent = new CustomEvent('updatePdfViewer', {
          detail: {
            pdfUrl: pdfUrl,
            documentTitle: getDocumentTitle(doc),
            isVisible: true,
            isMobile: isMobile()
          }
        });
        document.dispatchEvent(updateEvent);
        console.log('üì° Page - √âv√©nement updatePdfViewer envoy√©:', updateEvent.detail);
      } else {
        console.log('‚ùå Page - Document invalide:', doc);
      }
    });

    // G√©rer le redimensionnement de la fen√™tre
    window.addEventListener('resize', () => {
      if (!isMobile() && isMobileViewerMode) {
        // Si on repasse en desktop, r√©initialiser la vue
        toggleMobileView(false);
      }
    });

    function getDocumentTitle(doc: any) {
      if (doc.eventDate) {
        try {
          const d = new Date(doc.eventDate);
          return 'Compte rendu du ' + d.toLocaleDateString('fr-FR');
        } catch {}
      }
      return doc.name.replace('_readable.pdf', '').replace(/[-_]/g, ' ');
    }
  });
</script>

<style>
  .conseils-main {
    height: 100vh;
    overflow: hidden;
    padding: 0;
    margin: 0;
    background-color: #f9fafb;
  }

  .conseils-container {
    height: 100vh;
    min-height: 100vh;
    display: flex;
    transition: all 0.3s ease;
  }

  /* Colonne arborescence */
  .arborescence-column {
    width: 25%;
    min-width: 300px;
    height: 100vh;
    min-height: 100vh;
    transition: width 0.3s ease;
    overflow: hidden;
  }

  /* Colonne viewer */
  .viewer-column {
    width: 75%;
    height: 100vh;
    min-height: 100vh;
    opacity: 1;
    transition: all 0.3s ease;
    overflow: hidden;
    background-color: white;
  }

  /* Responsive Desktop */
  @media (max-width: 1024px) {
    .arborescence-column {
      width: 30%;
      min-width: 250px;
    }

    .viewer-column {
      width: 70%;
    }
  }

  /* Responsive Mobile */
  @media (max-width: 768px) {
    .conseils-container {
      position: relative;
      overflow: hidden;
    }

    /* Par d√©faut mobile : arborescence visible, viewer cach√© */
    .arborescence-column {
      width: 100%;
      height: 100vh;
      min-width: auto;
      position: relative;
      transform: translateX(0);
      transition: transform 0.3s ease;
    }

    .viewer-column {
      width: 100%;
      height: 100vh;
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(100%); /* Hors √©cran √† droite */
      transition: transform 0.3s ease;
    }

    /* Mode viewer mobile : arborescence cach√©e, viewer visible */
    .mobile-viewer-mode .arborescence-column.mobile-hidden {
      transform: translateX(-100%); /* Glisse vers la gauche */
    }

    .mobile-viewer-mode .viewer-column.mobile-visible {
      transform: translateX(0); /* Glisse pour √™tre visible */
    }
  }

  /* Masquer la margin du main global pour cette page */
  :global(.conseils-main) {
    max-width: none !important;
    margin: 0 !important;
  }
</style>
