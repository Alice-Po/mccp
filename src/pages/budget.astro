---
import Layout from '../layouts/Layout.astro';

// Données de test intégrées
const donneesComptables = {
  "donnees_comptables": [
    {
      "compte": "6042",
      "libelle": "Achats de prestations de services",
      "montant_realise": 2638.05
    },
    {
      "compte": "60611",
      "libelle": "Eau et assainissement",
      "montant_realise": 11928.15
    },
    {
      "compte": "60612",
      "libelle": "Energie - Electricité",
      "montant_realise": 65602.50
    },
    {
      "compte": "64111",
      "libelle": "Rémunération principale",
      "montant_realise": 158946.75
    },
    {
      "compte": "64131",
      "libelle": "Rémunérations",
      "montant_realise": 169098.71
    },
    {
      "compte": "6451",
      "libelle": "Cotisations à l'URSSAF",
      "montant_realise": 80779.71
    }
  ]
};

const chartColors = [
  '#2e8b57', // Vert primaire
  '#1b365d', // Bleu marine
  '#ac502b', // Accent
  '#747474', // Gris
  '#e0e0e0', // Gris clair
  '#ff6b6b'  // Rouge
];

const labels = donneesComptables.donnees_comptables.map(item => item.libelle);
const montants = donneesComptables.donnees_comptables.map(item => item.montant_realise);
---

<Layout title="Budget 2024 - MCC Putanges-le-Lac">
  <main>
    <section class="budget-section">
      <h1>Budget 2024</h1>
      <div class="budget-container">
        <div class="chart-container">
          <canvas id="budgetChart" aria-label="Graphique en camembert du budget 2024"></canvas>
        </div>
        <div class="budget-details">
          <h2>Détail du budget</h2>
          <ul class="budget-legend">
            {donneesComptables.donnees_comptables.map((item, index) => (
              <li>

                <div class="legend-color" style={`background-color: ${chartColors[index]}`}></div>
                <div class="legend-label">{item.libelle}</div>
                <div class="legend-value">{item.montant_realise.toLocaleString('fr-FR')} €</div>
              </li>
            ))}
          </ul>
        </div>
      </div>
    </section>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script define:vars={{ labels, montants, chartColors }}>
    // Attendre que le DOM soit chargé
    window.addEventListener('load', () => {
      try {
        // Vérifier les données
        console.log('Labels:', labels);
        console.log('Montants:', montants);
        console.log('Couleurs:', chartColors);

        const canvas = document.getElementById('budgetChart');
        if (!canvas) {
          console.error('Canvas #budgetChart non trouvé');
          return;
        }

        const ctx = canvas.getContext('2d');
        if (!ctx) {
          console.error('Contexte 2D du canvas non disponible');
          return;
        }

        // Importer Chart.js
          new Chart(ctx, {
            type: 'pie',
            data: {
              labels: labels,
              datasets: [{
                label: 'Budget Réalisé 2024',
                data: montants,
                backgroundColor: chartColors,
                borderWidth: 2,
                borderColor: '#ffffff'
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: {
                    font: {
                      family: 'League Spartan',
                      size: 12
                    },
                    padding: 15
                  }
                },
                title: {
                  display: true,
                  text: 'Répartition du budget 2024',
                  font: {
                    family: 'League Spartan',
                    size: 20,
                    weight: 'bold'
                  },
                  padding: 20
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      let label = context.label || '';
                      let value = Number(context.raw) || 0;
                      return `${label}: ${value.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} €`;
                    }
                  }
                }
              }
            }
          });

      } catch (error) {
        console.error('Erreur lors de la création du graphique:', error);
      }
    });
  </script>
</Layout>

<style>
  .budget-section {
    padding: 2rem 1rem;
  }
  .budget-container {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    align-items: start;
  }
  .chart-container {
    background: white;
    padding: 2rem;
    border-radius: 1rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
  }
  .budget-details {
    background: white;
    padding: 2rem;
    border-radius: 1rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
  }
  .budget-legend {
    list-style: none;
    padding: 0;
  }
  .budget-legend li {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
    padding: 0.5rem;
    border-radius: 0.5rem;
    background: #f8f9fa;
  }
  .legend-color {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    margin-right: 1rem;
  }
  .legend-label {
    flex: 1;
    font-weight: 500;
    color: #495057;
    font-size: 0.9rem;
  }
  .legend-value {
    font-weight: 600;
    color: #2e8b57;
  }
  @media (max-width: 768px) {
    .budget-container {
      grid-template-columns: 1fr;
    }
    .chart-container {
      margin-bottom: 1rem;
    }
  }
</style>
