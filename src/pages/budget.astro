---
import Layout from '../layouts/Layout.astro';

// Donn√©es de test int√©gr√©es
const donneesComptables = {
  "donnees_comptables": [
    {
      "compte": "6042",
      "libelle": "Achats de prestations de services",
      "montant_realise": 2638.05
    },
    {
      "compte": "60611",
      "libelle": "Eau et assainissement",
      "montant_realise": 11928.15
    },
    {
      "compte": "60612",
      "libelle": "Energie - Electricit√©",
      "montant_realise": 65602.50
    },
    {
      "compte": "64111",
      "libelle": "R√©mun√©ration principale",
      "montant_realise": 158946.75
    },
    {
      "compte": "64131",
      "libelle": "R√©mun√©rations",
      "montant_realise": 169098.71
    },
    {
      "compte": "6451",
      "libelle": "Cotisations √† l'URSSAF",
      "montant_realise": 80779.71
    }
  ]
};

const chartColors = [
  '#2e8b57', // Vert primaire
  '#1b365d', // Bleu marine
  '#ac502b', // Accent
  '#747474', // Gris
  '#e0e0e0', // Gris clair
  '#ff6b6b'  // Rouge
];

// Cr√©er un tableau avec les donn√©es et leurs couleurs, puis trier par montant d√©croissant
const dataWithColors = donneesComptables.donnees_comptables.map((item, index) => ({
  ...item,
  color: chartColors[index],
  originalIndex: index
})).sort((a, b) => b.montant_realise - a.montant_realise);

// Extraire les donn√©es tri√©es pour Chart.js
const labels = dataWithColors.map(item => item.libelle);
const montants = dataWithColors.map(item => item.montant_realise);
const sortedColors = dataWithColors.map(item => item.color);
---

<Layout title="Budget 2024 - MCC Putanges-le-Lac">
  <main>
    <!-- Message d'avertissement pour les petits √©crans -->
    <div class="screen-warning">
      <div class="warning-content">
        <h2>üìä Consultation du Budget</h2>
        <p>Pour une meilleure exp√©rience de consultation des donn√©es budg√©taires, nous vous recommandons d'utiliser un ordinateur ou un √©cran plus large.</p>
        <div class="warning-details">
          <p><strong>R√©solution minimale recommand√©e :</strong> 1400px de largeur</p>
          <p>Cette page contient des graphiques d√©taill√©s qui n√©cessitent plus d'espace d'affichage pour une lecture optimale.</p>
        </div>
        <div class="warning-actions">
          <a href="/" class="btn-home">‚Üê Retour √† l'accueil</a>
        </div>
      </div>
    </div>

    <!-- Contenu principal (masqu√© sur petits √©crans) -->
    <section class="budget-section">
      <h1>Budget 2024</h1>
      <div class="budget-container">
        <div class="chart-container">
          <canvas id="budgetChart" aria-label="Graphique en camembert du budget 2024"></canvas>
        </div>
        <div class="budget-details">
          <h2>D√©tail du budget</h2>
          <ul class="budget-legend">
            {dataWithColors.map((item, index) => (
              <li>
                <div class="legend-color" style={`background-color: ${item.color}`}></div>
                <div class="legend-label">{item.libelle}</div>
                <div class="legend-value">{item.montant_realise.toLocaleString('fr-FR')} ‚Ç¨</div>
              </li>
            ))}
          </ul>
        </div>
      </div>
    </section>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script define:vars={{ labels, montants, sortedColors }}>
    let chartInstance = null;

    // Attendre que le DOM soit charg√©
    window.addEventListener('load', () => {
      try {
        // V√©rifier les donn√©es
        console.log('Labels:', labels);
        console.log('Montants:', montants);
        console.log('Couleurs:', sortedColors);

        const canvas = document.getElementById('budgetChart');
        if (!canvas) {
          console.error('Canvas #budgetChart non trouv√©');
          return;
        }

        const ctx = canvas.getContext('2d');
        if (!ctx) {
          console.error('Contexte 2D du canvas non disponible');
          return;
        }

        // Cr√©er le graphique en camembert
        chartInstance = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: labels,
            datasets: [{
              label: 'Budget R√©alis√© 2024',
              data: montants,
              backgroundColor: sortedColors,
              borderWidth: 2,
              borderColor: '#ffffff',
              hoverBorderWidth: 4,
              hoverBorderColor: '#333333'
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: false
              },
              title: {
                display: true,
                text: 'R√©partition du budget 2024',
                font: {
                  family: 'League Spartan',
                  size: 20,
                  weight: 'bold'
                },
                padding: 20
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.label || '';
                    let value = Number(context.raw) || 0;
                    return `${label}: ${value.toFixed(2)} ‚Ç¨`;
                  }
                }
              }
            }
          }
        });

        // Ajouter les interactions avec la sidebar
        const legendItems = document.querySelectorAll('.budget-legend li');
        legendItems.forEach((item, index) => {
          item.addEventListener('mouseenter', () => {
            // Mettre en √©vidence le segment correspondant
            chartInstance.setActiveElements([{
              datasetIndex: 0,
              index: index
            }]);
            chartInstance.update('none');
            
            // Ajouter une classe CSS pour l'effet visuel sur l'item
            item.classList.add('legend-hover');
          });

          item.addEventListener('mouseleave', () => {
            // Enlever la mise en √©vidence
            chartInstance.setActiveElements([]);
            chartInstance.update('none');
            
            // Enlever la classe CSS
            item.classList.remove('legend-hover');
          });
        });

      } catch (error) {
        console.error('Erreur lors de la cr√©ation du graphique:', error);
      }
    });
  </script>
</Layout>

<style>
    main {
        width: auto;
        max-width: 1200px;
        margin: 0 auto;
    }

    /* Message d'avertissement - masqu√© par d√©faut */
    .screen-warning {
      display: none;
      min-height: 100vh;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    .warning-content {
      max-width: 600px;
      text-align: center;
      background: white;
      padding: 3rem;
      border-radius: 1.5rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      border: 2px solid #2e8b57;
    }

    .warning-content h2 {
      color: #2e8b57;
      margin-bottom: 1.5rem;
      font-size: 2rem;
    }

    .warning-content p {
      color: #495057;
      margin-bottom: 1rem;
      line-height: 1.6;
      font-size: 1.1rem;
    }

    .warning-details {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 1rem;
      margin: 2rem 0;
      border-left: 4px solid #2e8b57;
    }

    .warning-details p {
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }

    .btn-home {
      display: inline-block;
      padding: 1rem 2rem;
      background: #2e8b57;
      color: white;
      text-decoration: none;
      border-radius: 0.5rem;
      font-weight: 600;
      transition: all 0.2s ease;
      margin-top: 1rem;
    }

    .btn-home:hover {
      background: #1b5e39;
      transform: translateY(-2px);
    }

    /* Affichage conditionnel bas√© sur la largeur d'√©cran */
    @media (max-width: 1399px) {
      .screen-warning {
        display: flex;
      }
      
      .budget-section {
        display: none;
      }
    }

    /* Styles pour √©crans ‚â• 1400px */
    @media (min-width: 1400px) {
      .screen-warning {
        display: none;
      }
      
      .budget-section {
        display: block;
        padding: 2rem 1rem;
        width: 100%;
      }
    }

    .budget-container {
      width: 100%;
      margin: 0;
      padding: 0 2rem;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 3rem;
      align-items: start;
    }
    .chart-container {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      width: 100%;
    }
    .budget-details {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      width: 100%;
    }
    .budget-legend {
      list-style: none;
      padding: 0;
    }
    .budget-legend li {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 0.5rem;
      background: #f8f9fa;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .budget-legend li:hover,
    .budget-legend li.legend-hover {
      background: #e9ecef;
      transform: translateX(4px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .legend-color {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      margin-right: 1.5rem;
      transition: transform 0.2s ease;
      flex-shrink: 0;
    }
    
    .budget-legend li:hover .legend-color,
    .budget-legend li.legend-hover .legend-color {
      transform: scale(1.2);
    }
    
    .legend-label {
      flex: 1;
      font-weight: 500;
      color: #495057;
      font-size: 1rem;
      margin-right: 1rem;
    }
    .legend-value {
      font-weight: 600;
      color: #2e8b57;
      font-size: 1.1rem;
      text-align: right;
      min-width: 140px;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 3rem;
      font-size: 2.5rem;
    }
    
    h2 {
      margin-bottom: 2rem;
      font-size: 1.5rem;
    }
</style>
